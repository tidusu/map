<html>

<head>
    <meta charset="utf-8">
    <title>Map</title>
</head>
<style>
    body {
        background: #000;
    }
    .country{
      fill: white;
      stroke: rgb(0, 0, 0);
      stroke-width: .2px;
    }
    .city {
        fill: rgb(0, 70, 121);
        fill-opacity: .8;
    }
    .countryline{
      /* fill: rgb(37, 37, 37); */
      stroke: rgb(26, 26, 26);
      stroke-width: 1px;
    }
</style>

<body>
    <script src="js/queue.js"></script>
    <!-- <script src="http://d3js.org/d3.v3.min.js"></script> -->
    <!-- <script src="js/d3.v3.min.js"></script> -->
    <script src="js/topojson.v1.min.js"></script>
    <script src="https://d3js.org/d3.v4.js"></script>
    <script src="https://d3js.org/d3-scale-chromatic.v1.min.js"></script>
    <script src="https://d3js.org/d3-geo-projection.v2.min.js"></script>
    <script>

        var width = 1000;
        var height = 1000;

        var svg = d3.select("body").append("svg")
            .attr("width", width)
            .attr("height", height)
            .append("g")
            .attr("transform", "translate(0,0)");

        var projection = d3.geoMercator()
            .center([0, 0])
            .scale(150)
            .translate([width / 2, height / 2]);

        var link = { type: "LineString", coordinates: [[100, 60], [-60, -30]] } // Change these data to see ho the great circle reacts

        var path = d3.geoPath()
            .projection(projection);

        var radius = d3.scaleSqrt()
            .domain([0, 1000])
            .range([0, 2]);

        // 设置颜色比例尺
        var colorA = d3.hsl(220, 0.8, 0.8); // 蓝色
        var colorB = d3.hsl(220, 0.01, 0.1); // 白色

        // computeColor(i)，i为0~1，输出colorA、colorB之间的数
        var computeColor = d3.interpolate(colorB, colorA);
        var compute = d3.scaleLinear()
            .domain([0, 200])
            .range([0, 1]);

        var computeR = d3.scaleLog()
            .domain([0, 200])
            .range([0, 10]);

        var g_world = svg.append("g");
        var g_nine = svg.append("g");
        var g_link = svg.append("g");

        queue()
            .defer(d3.json, "data/world.geo.json")
            .defer(d3.csv, "data/user.csv")
            .defer(d3.csv, "data/user_arc.csv")
            .defer(d3.json, "data/9-topo.json")
            .await(ready);


        function ready(error, countries, user, cities,nine) {
        
            // 连线
            var link = []
            cities.forEach(function (row) {
                source = [+row.lng1, +row.lat1]
                target = [+row.lng2, +row.lat2]
                topush = { type: "LineString", coordinates: [source, target] }
                link.push(topush)
            })

            var country = g_world.selectAll("path")
                .data(countries.features)
                // .data(topojson.feature(countries, countries.objects.worldEn).features) // 对每一个数据绑定一个path
                .enter()
                .append("path") // 对每一个数据绑定一个path
                .attr("class", "country")
                .attr("d", path)
                .style("fill", function (d, i) {
                    var temp_n = 1;
                    for (var j = 0; j < user.length; j++) {
                        if (d.properties.ADMIN == user[j].country) {
                            temp_n = user[j].value;
                            break;
                        }
                    }
                    var m = compute(temp_n);
                    return computeColor(m);
                });

            //九段线
            var country_line = g_nine.selectAll("path")
                // .selectAll("countryline")
                .data(topojson.feature(nine, nine.objects.nine).features)
                .enter()
                .append("path")
                .attr("class", "countryline")
                .attr("d", path)

            var city = g_link.selectAll("path")
                .data(cities)
                .enter()
                .append("g")
                .attr("class", "city")
                .attr("transform", function (d, i) {
                    var coor = projection([d.lng2, d.lat2]);
                    return "translate(" + coor[0] + ", " + coor[1] + ")";
                })
                .append("circle")
                .attr("r", function (d) { return radius(d.sum); });

            var links = g_link.selectAll("path")
                .data(link)
                .enter()
                .append("path")
                .attr("d", function (d) { return path(d) })
                .style("fill", "none")
                .style("stroke", "#0192FA")
                .style("stroke-opacity", .8)
                .style("stroke-width", .1)
        } 
        
        
    </script>
</body>

</html>