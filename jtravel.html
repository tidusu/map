<!DOCTYPE html>
<html>

<head>
    <meta charset='utf-8' />
    <title>Store Locator</title>
    <meta name='robots' content='noindex, nofollow'>
    <meta name='viewport' content='initial-scale=1,maximum-scale=1,user-scalable=no' />
    <link href='https://fonts.googleapis.com/css?family=Source+Sans+Pro:400,700' rel='stylesheet'>
    <script src='https://api.tiles.mapbox.com/mapbox-gl-js/v0.54.0/mapbox-gl.js'></script>
    <link href='https://api.tiles.mapbox.com/mapbox-gl-js/v0.54.0/mapbox-gl.css' rel='stylesheet' />
    <link href='css/jtravel.css' rel='stylesheet' />
    <script src="https://code.jquery.com/jquery-3.4.0.slim.min.js"
        integrity="sha256-ZaXnYkHGqIhqTbJ6MB4l9Frs/r7U4jlx7ir8PJYBqbI=" crossorigin="anonymous"></script>

</head>

<body>
    <div class='hide_btn'><input id='sbutton' type='checkbox' checked='checked'></div>

    <div class='sidebar transform'>
        <div class='heading'>
            <h1>locations </h1>
            <a id="language" href="javascript:void(0);" onclick="change_language('ja')">| 日 |</a>
            <a id="language" href="javascript:void(0);" onclick="change_language('en')"> En |</a>
            <a id="language" href="javascript:void(0);" onclick="change_language('zh-Hans')"> 中 |</a>
            <div id='menu'>
                <input id='mapbox://styles/tidusu/cjbxnenp6d8sv2sqdoprjhi7x' type='radio' name='rtoggle' value='classic'
                    checked='checked'>
                <label for='classic'>老久</label>
                <input id='mapbox://styles/mapbox/streets-v11' type='radio' name='rtoggle' value='streets'>
                <label for='streets'>街道</label>
                <input id='mapbox://styles/mapbox/light-v10' type='radio' name='rtoggle' value='light'>
                <label for='light'>淡雅</label>
                <input id='mapbox://styles/tidusu/cjv2jbx6z0fno1fpjqw0a07tr' type='radio' name='rtoggle'
                    value='satellite'>
                <label for='satellite'>卫星</label>
            </div>
        </div>
        <div id='listings' class='listings'></div>
    </div>
    <div id='map' class='map maptransform'> </div>
    <!-- filter -->
    <div class='filter-ctrl'>
        <input id='filter-input' type='text' name='filter' placeholder='Filter by name' />
    </div>
    <script src='js/poi.js'></script>
    <script src='js/utils.js'></script>
    <script>
        var layerList = document.getElementById('menu');
        var inputs = layerList.getElementsByTagName('input');
        // This will let you use the .remove() function later on
        if (!('remove' in Element.prototype)) {
            Element.prototype.remove = function () {
                if (this.parentNode) {
                    this.parentNode.removeChild(this);
                }
            };
        }

        mapboxgl.accessToken =
            'pk.eyJ1IjoidGlkdXN1IiwiYSI6ImNqdHNndGM2bjB4Y3c0MnIwbHg4Y20xNmgifQ.KiFS1iqSrCMvik2S_AC7WA';

        // This adds the map
        var map = new mapboxgl.Map({
            // container id specified in the HTML
            container: 'map',
            // style URL

            // style: 'mapbox://styles/mapbox/streets-v11',
            style: 'mapbox://styles/tidusu/cjbxnenp6d8sv2sqdoprjhi7x',
            // initial position in [long, lat] format
            center: [135.758645, 35.000869],
            // initial zoom
            zoom: 13,
            // scrollZoom: false
        });

        // This adds the data to the map
        map.on('load', function (e) {

            // This is where your '.addLayer()' used to be, instead add only the source without styling a layer
            map.addSource("places", {
                "type": "geojson",
                "data": poi
            });

            
            // map.addLayer({
            //     "type": "symbol",
            //     "source": "places",
            //     "layout": {
            //         "icon-image": "restaurant-15",
            //         "text-field": places.properties.icon,
            //         // "text-font": ["Open Sans Bold", "Arial Unicode MS Bold"],
            //         "text-size": 11,
            //         "text-transform": "uppercase",
            //         "text-letter-spacing": 0.05,
            //         "text-offset": [0, 1.5]
            //     },
            //     "paint": {
            //         "text-color": "#202",
            //         "text-halo-color": "#fff",
            //         "text-halo-width": 2
            //     },
            //     "filter": ["==", "icon", symbol]
            // });

            map.addLayer({
                "id": "route",
                "type": "line",
                "source": {
                    "type": "geojson",
                    "data": line1
                },
                "layout": {
                    "line-join": "round",
                    "line-cap": "round"
                },
                "paint": {
                    "line-color": "#0192FA",
                    "line-opacity": 0.5,
                    "line-width": 8
                }
            });
            // Initialize the list
            buildLocationList(poi);

            change_language('ja');

            for (var i = 0; i < inputs.length; i++) {
                inputs[i].onclick = switchLayer;
            }

        });

        // This is where your interactions with the symbol layer used to be
        // Now you have interactions with DOM markers instead
        poi.features.forEach(function (marker, i) {
            // Create an img element for the marker
            var el = document.createElement('div');
            el.id = "marker-" + i;
            if (marker.properties.icon == 'hotel') {
                el.className = 'marker_hotel';
            } else if (marker.properties.icon == 'site') {
                el.className = 'marker_site';
            } else if (marker.properties.icon == 'drink') {
                el.className = 'marker_snack';
            } else if (marker.properties.icon == 'hotel') {
                el.className = 'marker_hotel';
            } else if (marker.properties.icon == 'hotel') {
                el.className = 'marker';
            } else {
                el.className = 'marker';
            }

            // Add markers to the map at all points
            new mapboxgl.Marker(el, {
                    offset: [0, -14],

                })
                .setLngLat(marker.geometry.coordinates)
                .addTo(map);

            

            el.addEventListener('click', function (e) {
                // 1. Fly to the point
                flyToStore(marker);

                // 2. Close all other popups and display popup for clicked store
                createPopUp(marker);

                // 3. Highlight listing in sidebar (and remove highlight for all other listings)
                var activeItem = document.getElementsByClassName('active');

                e.stopPropagation();
                if (activeItem[0]) {
                    activeItem[0].classList.remove('active');
                }

                var listing = document.getElementById('listing-' + i);
                listing.classList.add('active');

            });
        });


        function flyToStore(currentFeature) {
            map.flyTo({
                center: currentFeature.geometry.coordinates,
                zoom: 14
            });
        }

        function createPopUp(currentFeature) {
            var popUps = document.getElementsByClassName('mapboxgl-popup');
            if (popUps[0]) popUps[0].remove();

            lat = currentFeature.geometry.coordinates[1];
            lng = currentFeature.geometry.coordinates[0];
            map_link = "javascript:if(confirm('是否打开导航地图'))\{location='http://www.google.cn/maps/place/" + lat + "," +
                lng + "/@" + lat + "," + lng + ",15z'\}";

            // link = "<a" + "href=" + map_link + "\">" + H3 + H4 + "</a>"
            H3 = '<h3>' + "<a " + "href=" + map_link + ">" + currentFeature.properties.Name + "</a>" + '</h3>';
            H4 = '<h4>' + currentFeature.properties.icon + '</h4>';
            link = H3 + H4;

            var popup = new mapboxgl.Popup({
                    closeOnClick: false
                })
                .setLngLat(currentFeature.geometry.coordinates)
                .setHTML(link)
                .addTo(map);
        }

        function buildLocationList(data) {
            for (i = 0; i < data.features.length; i++) {
                var currentFeature = data.features[i];
                var prop = currentFeature.properties;

                var listings = document.getElementById('listings');
                var listing = listings.appendChild(document.createElement('div'));
                listing.className = 'item';
                listing.id = "listing-" + i;

                var link = listing.appendChild(document.createElement('a'));
                link.href = '#';
                link.className = 'title';
                link.dataPosition = i;
                link.innerHTML = prop.Name;

                var details = listing.appendChild(document.createElement('div'));
                details.innerHTML = prop.icon;
                if (prop.phone) {
                    details.innerHTML += ' &middot; ' + prop.phoneFormatted;
                }

                link.addEventListener('click', function (e) {
                    // Update the currentFeature to the store associated with the clicked link
                    var clickedListing = data.features[this.dataPosition];

                    // 1. Fly to the point
                    flyToStore(clickedListing);

                    // 2. Close all other popups and display popup for clicked store
                    createPopUp(clickedListing);

                    // 3. Highlight listing in sidebar (and remove highlight for all other listings)
                    var activeItem = document.getElementsByClassName('active');

                    if (activeItem[0]) {
                        activeItem[0].classList.remove('active');
                    }
                    this.parentNode.classList.add('active');

                });
            }
        }

        function switchLayer(layer) {
            var layerId = layer.target.id;
            map.setStyle(layerId);
        }

        $("#sbutton").click(function () {
            console.log('hit')
            $('.transform').toggleClass('transform-active');
            $('.maptransform').toggleClass('maptransform-active');
        });
    </script>
</body>

</html>